"use client";

import React, { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { notFound } from "next/navigation";
import { useAuth } from "~/hooks/useAuth";
import { api } from "~/trpc/react";
import { generateSeoSlug, validateSeoSlug } from "~/lib/seo";
import EnhancedFahndungWizard from "~/components/fahndungen/EnhancedFahndungWizard";
import { LoadingSpinner } from "~/components/ui/LoadingSpinner";

interface PageProps {
  params: { slug: string };
}

export default function FahndungBearbeitenPage({ params }: PageProps) {
  const router = useRouter();
  const { session, loading: authLoading, initialized } = useAuth();
  const [investigationData, setInvestigationData] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true);

  const slug = params.slug;

  // Pr√ºfe ob es eine Fallnummer ist
  const isCaseNumber = /^(?:POL-)?\d{4}-[A-Z]-\d{3,6}(?:-[A-Z])?$/.test(slug);

  // tRPC Query f√ºr die Fahndung
  const { data: investigation, isLoading: investigationLoading } = api.post.getInvestigation.useQuery(
    { id: isCaseNumber ? slug : "" },
    { 
      enabled: !!isCaseNumber && !!session && (
        session.profile?.role === "editor" || 
        session.profile?.role === "admin" || 
        session.profile?.role === "super_admin"
      )
    }
  );

  // Authentifizierungspr√ºfung
  useEffect(() => {
    if (!initialized || authLoading) return;

    if (!session) {
      console.log("üîê Keine Session - Weiterleitung zu Login");
      router.push("/login");
      return;
    }

    // Pr√ºfe Editor/Admin/Super-Admin Rechte
    const role = session.profile?.role;
    if (role !== "editor" && role !== "admin" && role !== "super_admin") {
      console.log("‚ùå Unzureichende Rechte - nur Editor/Admin/Super-Admin erlaubt");
      router.push("/dashboard?error=insufficient_permissions");
      return;
    }
  }, [session, authLoading, initialized, router]);

  // Lade Fahndungsdaten
  useEffect(() => {
    if (!investigation && !investigationLoading && session) {
      // Wenn keine direkte Fallnummer, versuche √ºber Slug zu finden
      if (!isCaseNumber) {
        // TODO: Implementiere findInvestigationBySlug f√ºr Client-Side
        console.error("SEO-Slug Suche noch nicht f√ºr Client-Side implementiert");
        notFound();
      }
      setIsLoading(false);
    } else if (investigation) {
      // Konvertiere zu Wizard-Format
      const wizardData = {
        step1: {
          title: investigation.title,
          caseNumber: investigation.case_number,
          category: investigation.category as
            | "WANTED_PERSON"
            | "MISSING_PERSON"
            | "UNKNOWN_DEAD"
            | "STOLEN_GOODS",
        },
        step2: {
          description: investigation.description,
          shortDescription: investigation.short_description,
          features: investigation.features,
          priority: investigation.priority,
          tags: investigation.tags,
        },
        step3: {
          mainImage: null,
          mainImageUrl:
            investigation.images?.[0]?.url ??
            "/images/placeholders/fotos/platzhalterbild.svg",
          additionalImages: [],
          additionalImageUrls:
            investigation.images?.slice(1).map((img) => img.url) ?? [],
          documents: [],
        },
        step4: {
          mainLocation: investigation.location
            ? {
                id: "main-location",
                address: investigation.location,
                lat: 0,
                lng: 0,
                type: "main" as const,
              }
            : null,
          additionalLocations: [],
          searchRadius: 5,
        },
        step5: {
          contactPerson:
            (investigation.contact_info?.["person"] as string) ?? "Polizei",
          contactPhone:
            (investigation.contact_info?.["phone"] as string) ?? "+49 711 8990-0",
          contactEmail: (investigation.contact_info?.["email"] as string) ?? "",
          department: investigation.station ?? "Polizeipr√§sidium",
          availableHours: "24/7",
          publishStatus: "draft" as const,
          urgencyLevel: "medium" as const,
          requiresApproval: false,
          visibility: {
            internal: true,
            regional: true,
            national: false,
            international: false,
          },
          notifications: {
            emailAlerts: true,
            smsAlerts: false,
            appNotifications: true,
            pressRelease: false,
          },
          articlePublishing: {
            publishAsArticle: false,
            generateSeoUrl: true,
            keywords: [],
          },
        },
      };

      setInvestigationData(wizardData);
      setIsLoading(false);
    }
  }, [investigation, investigationLoading, isCaseNumber, session]);

  // Loading States
  if (!initialized || authLoading || isLoading || investigationLoading) {
    return (
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
        <div className="flex h-screen items-center justify-center">
          <LoadingSpinner message="Lade Fahndungsdaten..." />
        </div>
      </div>
    );
  }

  // Keine Session oder unzureichende Rechte
  if (!session || (
    session.profile?.role !== "editor" && 
    session.profile?.role !== "admin" && 
    session.profile?.role !== "super_admin"
  )) {
    return (
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
        <div className="flex h-screen items-center justify-center">
          <div className="text-center">
            <div className="mb-4 text-4xl">üîê</div>
            <div className="text-xl font-semibold">Zugriff verweigert</div>
            <div className="mt-2 text-gray-400">Nur Editor/Admin/Super-Admin k√∂nnen bearbeiten</div>
          </div>
        </div>
      </div>
    );
  }

  // Fahndung nicht gefunden
  if (!investigationData) {
    return (
      <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
        <div className="flex h-screen items-center justify-center">
          <div className="text-center">
            <div className="mb-4 text-4xl">‚ùå</div>
            <div className="text-xl font-semibold">Fahndung nicht gefunden</div>
            <div className="mt-2 text-gray-400">Die angeforderte Fahndung existiert nicht</div>
          </div>
        </div>
      </div>
    );
  }

  // Berechtigungen OK - Zeige Wizard im Edit-Modus
  return <EnhancedFahndungWizard initialData={investigationData} mode="edit" />;
}